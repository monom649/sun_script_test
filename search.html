<!DOCTYPE html>
<html>
<head>
    <title>ã‚µãƒ³ã‚µãƒ³ã‚­ãƒƒã‚ºTV å°æœ¬æ¤œç´¢ã‚·ã‚¹ãƒ†ãƒ </title>
    <meta charset="UTF-8">
</head>
<body>
    <h1>ğŸ¬ ã‚µãƒ³ã‚µãƒ³ã‚­ãƒƒã‚ºTV å°æœ¬æ¤œç´¢ã‚·ã‚¹ãƒ†ãƒ </h1>
    
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <div>
            <label>ğŸ” æ¤œç´¢ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ï¼š</label>
            <input type="text" id="keyword" placeholder="ä¾‹: ã‚µãƒ³ã‚µãƒ³ã€ãã‚‚ã‚Šã‚“">
            <button onclick="performSearch()">æ¤œç´¢å®Ÿè¡Œ</button>
        </div>
        <button onclick="logout()" style="background: #dc3545; color: white; padding: 8px 12px; font-size: 14px; border: none; border-radius: 5px; cursor: pointer;">ğŸšª ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
    </div>
    
    <div id="loading" style="display: none;">
        <p>ğŸ”„ æ¤œç´¢ä¸­...</p>
    </div>
    
    <div id="results" style="display: none;">
        <h3 id="resultsHeader"></h3>
        <div id="resultsList"></div>
    </div>
    
    <div id="error" style="display: none; color: red;"></div>

    <script>
        async function performSearch() {
            var keyword = document.getElementById('keyword').value.trim();
            
            if (!keyword) {
                showError('ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }
            
            hideError();
            showLoading();
            
            try {
                console.log('æ¤œç´¢ãƒªã‚¯ã‚¨ã‚¹ãƒˆé–‹å§‹:', keyword);
                
                var response = await fetch('/api/search', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        keyword: keyword
                    })
                });
                
                console.log('ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹:', response.status);
                
                if (!response.ok) {
                    throw new Error('HTTP ' + response.status + ': ' + response.statusText);
                }
                
                var data = await response.json();
                console.log('ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãƒ‡ãƒ¼ã‚¿:', data);
                
                if (data.success) {
                    displayResults(data);
                } else {
                    showError('ã‚¨ãƒ©ãƒ¼: ' + data.error);
                }
                
            } catch (error) {
                console.error('æ¤œç´¢ã‚¨ãƒ©ãƒ¼:', error);
                showError('ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼: ' + error.message);
            } finally {
                hideLoading();
            }
        }
        
        function displayResults(data) {
            var resultsDiv = document.getElementById('results');
            var headerDiv = document.getElementById('resultsHeader');
            var listDiv = document.getElementById('resultsList');
            
            headerDiv.innerHTML = 'æ¤œç´¢çµæœ: "' + data.keyword + '" (' + data.count + 'ä»¶)';
            
            var html = '';
            for (var i = 0; i < data.results.length; i++) {
                var result = data.results[i];
                html += '<div style="border: 1px solid #ccc; margin: 10px; padding: 10px;">';
                html += '<h4>' + result.title + ' (' + result.management_id + ')</h4>';
                html += '<p><strong>é…ä¿¡æ—¥:</strong> ' + (result.broadcast_date || 'ãªã—') + '</p>';
                if (result.script_url) {
                    html += '<p><strong>å°æœ¬URL:</strong> <a href="' + result.script_url + '" target="_blank" style="color: #007bff;">ğŸ“‹ å°æœ¬ã‚’é–‹ã</a></p>';
                }
                html += '<p><strong>è¡Œç•ªå·:</strong> ' + (result.row_number || 'ãªã—') + '</p>';
                html += '<p><strong>ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼:</strong> ' + (result.character_name || 'ãªã—') + '</p>';
                html += '<p><strong>ã‚»ãƒªãƒ•:</strong> ' + (result.dialogue || 'ãªã—') + '</p>';
                if (result.voice_instruction) {
                    html += '<p><strong>éŸ³å£°æŒ‡ç¤º:</strong> ' + result.voice_instruction + '</p>';
                }
                if (result.filming_instruction) {
                    html += '<p><strong>æ’®å½±æŒ‡ç¤º:</strong> ' + result.filming_instruction + '</p>';
                }
                if (result.editing_instruction) {
                    html += '<p><strong>ç·¨é›†æŒ‡ç¤º:</strong> ' + result.editing_instruction + '</p>';
                }
                html += '</div>';
            }
            
            listDiv.innerHTML = html;
            resultsDiv.style.display = 'block';
        }
        
        function showLoading() {
            document.getElementById('loading').style.display = 'block';
            document.getElementById('results').style.display = 'none';
        }
        
        function hideLoading() {
            document.getElementById('loading').style.display = 'none';
        }
        
        function showError(message) {
            var errorDiv = document.getElementById('error');
            errorDiv.innerHTML = message;
            errorDiv.style.display = 'block';
            console.error('Error:', message);
        }
        
        function hideError() {
            document.getElementById('error').style.display = 'none';
        }
        
        // èªè¨¼ãƒã‚§ãƒƒã‚¯æ©Ÿèƒ½
        function checkAuth() {
            const auth = sessionStorage.getItem('sunsun_auth');
            const authTime = sessionStorage.getItem('sunsun_auth_time');
            
            if (auth !== 'true' || !authTime) {
                window.location.href = '/index.html';
                return false;
            }
            
            const now = Date.now();
            const authTimestamp = parseInt(authTime);
            const hoursPassed = (now - authTimestamp) / (1000 * 60 * 60);
            
            // 24æ™‚é–“çµŒéã§ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
            if (hoursPassed >= 24) {
                sessionStorage.removeItem('sunsun_auth');
                sessionStorage.removeItem('sunsun_auth_time');
                window.location.href = '/index.html';
                return false;
            }
            
            return true;
        }
        
        // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆæ©Ÿèƒ½
        function logout() {
            sessionStorage.removeItem('sunsun_auth');
            sessionStorage.removeItem('sunsun_auth_time');
            window.location.href = '/index.html';
        }
        
        // Enterã‚­ãƒ¼ã§æ¤œç´¢
        document.getElementById('keyword').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                performSearch();
            }
        });
        
        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã®èªè¨¼ãƒã‚§ãƒƒã‚¯
        document.addEventListener('DOMContentLoaded', function() {
            if (!checkAuth()) {
                return;
            }
            log('èªè¨¼æ¸ˆã¿ãƒ¦ãƒ¼ã‚¶ãƒ¼ - ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿å®Œäº†');
        });
    </script>
</body>
</html>